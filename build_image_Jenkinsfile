pipeline{
    agent any
    stages{
        stage('Build images'){
            steps{
                sh 'docker-compose build'
            }
        }
        stage('Run Containers'){
            steps{
                sh 'docker-compose up -d'
            }
        }
        stage('Test services'){
            steps{
                echo 'nothing!'
                //write checking script
            }
        }
        stage('Push images to registry'){
            steps{
                sh 'docker tag backend_build_back:latest registry.hiriko.local:5000/back:${BUILD_NUMBER}'
                sh 'docker push registry.hiriko.local:5000/back:${BUILD_NUMBER}'
                sh 'docker tag backend_build_db_postgre:latest registry.hiriko.local:5000/db_postgre:${BUILD_NUMBER}'
                sh 'docker push registry.hiriko.local:5000/db_postgre:${BUILD_NUMBER}'
            }
        }
        stage('Stop docker images'){
            steps{
                sh 'docker-compose stop '
                sh 'docker-compose rm -f '
                sh 'docker volume rm $(docker volume ls -q)'
                sh 'docker image rm $(docker image ls -q) -f'
            }
        }
    }
    post{
        always{
            cleanWs()
        }
        success{
            build job: 'Deploy' , parameters: [string(name: 'TAG_BACK', value: "${env.BUILD_NUMBER}")] , propagate: true
        }
    }
}