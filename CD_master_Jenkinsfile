pipeline{
    agent any
options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5'))
}
parameters{
    string(description: 'backend image version', name: 'TAG_BACK')
    }
    stages{
        stage('Pull image from registry') {
            steps {
                sh 'docker pull registry.hiriko.local:5000/back:${TAG_BACK}'
                sh 'docker pull registry.hiriko.local:5000/postgres:11.2-alpine'
            }
        }
        stage('Stop running containers') {
            steps {
                sh 'docker container rm -f backend'
                sh 'docker container rm -f db_postgre'
            }
        }
        stage('RUN SERVICES') {
            steps {
                sh 'docker-compose -f Prod.backend.yml up -d'
            }
        }
        stage('Test service'){
            options{
                timeout( time: 2 , unit: "MINUTES")
            }
            steps{
                sh 'bash check_service.sh'
            }
        }
    }
    post { 
        always { 
            cleanWs()
        }
        aborted {
            //slackSend 
            echo 'bad'
            
        }
        success{
            //slackSend
            echo 'good'
        }
    }
    
}